# 前端显示优化说明

## 优化内容

针对 Claude CLI 的 `stream-json` 输出格式，优化了前端的消息显示逻辑，解决了"每次输入一次命令，都会有多个JSON返回"的问题。

## 主要改进

### 1. 工具调用卡片化显示

**之前的问题：**
- 工具调用和结果分散显示
- 大量系统消息占据屏幕空间
- 无法直观看到工具执行状态

**现在的解决方案：**
- 每个工具调用创建独立的卡片
- 卡片显示：工具名称、输入参数、执行状态、输出结果
- 实时更新状态：执行中 → 成功/失败

```
┌─────────────────────────────────────┐
│ 🔧 Bash              执行中...      │
├─────────────────────────────────────┤
│ npx create-next-app@latest .        │
└─────────────────────────────────────┘

更新为：

┌─────────────────────────────────────┐
│ 🔧 Bash              ✅ 成功         │
├─────────────────────────────────────┤
│ npx create-next-app@latest .        │
├─────────────────────────────────────┤
│ ✔ Success! Created next-app         │
└─────────────────────────────────────┘
```

### 2. 智能输出折叠

**功能：**
- 工具输出超过 1000 字符自动折叠
- 显示"显示完整输出"按钮
- 点击可展开/收起完整内容

**好处：**
- 避免超长输出占据屏幕
- 保持界面整洁
- 需要时可查看完整内容

### 3. 统计信息聚合

**之前：** 只显示费用

**现在：** 在对话结束时显示完整统计
```
✅ 完成 - 💰 $0.026661 | ⏱️ 20.0s | 🔄 7轮
```

### 4. 消息类型优化

- **Assistant 文本消息**: 流式显示，实时更新
- **工具调用**: 卡片化显示，状态实时更新
- **工具结果**: 自动关联到对应的工具卡片
- **系统消息**: 仅显示关键信息（初始化、完成、错误）

## 技术实现

### 核心数据结构

```javascript
let pendingToolCalls = new Map(); // 追踪正在执行的工具调用

// 工具调用时
pendingToolCalls.set(toolId, { name, input });

// 工具结果返回时
updateToolCallResult(toolId, result);
pendingToolCalls.delete(toolId);
```

### 关键函数

1. **createToolCallCard()** - 创建工具卡片
2. **updateToolCallResult()** - 更新工具执行结果
3. **toggleToolOutput()** - 展开/收起长输出
4. **formatToolInput()** - 智能格式化工具参数

### 消息流程

```
用户输入 "初始化一个nextjs项目"
    ↓
system/init → 🚀 会话初始化完成
    ↓
assistant/text → Claude 说明要做什么
    ↓
assistant/tool_use → 创建工具卡片 (执行中...)
    ↓
user/tool_result → 更新卡片状态和结果 (✅ 成功)
    ↓
(重复工具调用流程，直到完成)
    ↓
result/success → ✅ 完成 - 费用 | 耗时 | 轮次
```

## 样式设计

### 工具卡片样式
- 深色主题适配
- 状态颜色区分（执行中/成功/失败）
- 代码块使用等宽字体
- 输出区域限高滚动

### 状态指示
- 🟡 执行中 (黄色背景)
- 🟢 成功 (绿色背景)
- 🔴 失败 (红色背景)

## 使用效果

**之前的显示：**
```
我将为你初始化一个 Next.js 项目。
🔧 Bash: npx create-next-app@latest .
✅ 工具执行结果:
(大量输出...)
🔧 Bash: cd . && npm run dev
✅ 工具执行结果:
(更多输出...)
💰 费用: $0.026661
```

**现在的显示：**
```
┌─ Claude ─────────────────────────┐
│ 我将为你初始化一个 Next.js 项目。│
└──────────────────────────────────┘

┌─ 工具调用 ───────────────────────┐
│ 🔧 Bash          ✅ 成功          │
│ npx create-next-app@latest .     │
│ ✔ Success! Created next-app      │
│ [显示完整输出 (2345 字符)]       │
└──────────────────────────────────┘

┌─ 工具调用 ───────────────────────┐
│ 🔧 Bash          ✅ 成功          │
│ cd . && npm run dev              │
│ > next-app@0.1.0 dev             │
│ [显示完整输出 (1234 字符)]       │
└──────────────────────────────────┘

✅ 完成 - 💰 $0.026661 | ⏱️ 20.0s | 🔄 7轮
```

## 优势总结

1. **信息组织更清晰** - 每个工具调用作为独立单元
2. **状态跟踪更直观** - 实时显示执行状态
3. **屏幕利用更高效** - 长输出折叠，节省空间
4. **用户体验更好** - 减少滚动，信息密度适中
5. **调试更方便** - 工具输入输出一目了然
